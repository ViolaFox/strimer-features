<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>MiniChat Silent Smoke</title>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
      }

      img {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        pointer-events: none;
        transition: opacity 1s ease;
      }

      #smokeGif {
        width: 500px;
        z-index: 2; /* –¥—ã–º —Å–≤–µ—Ä—Ö—É */
      }

      #textPng {
        width: 400px;
        z-index: 1; /* —Ç–µ–∫—Å—Ç —Å–Ω–∏–∑—É */
      }

      .fade-in {
        opacity: 1;
      }
      .fade-out {
        opacity: 0;
      }
    </style>
  </head>

  <body>
    <img id="smokeGif" src="smoke.gif" />
    <img id="textPng" src="text.png" />

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /* ===== –ù–ê–°–¢–†–û–ô–ö–ò (–í–°–ï –†–ê–ó–î–ï–õ–ï–ù–´) ===== */

        const BOT_NAME = "niahkingame";

        const SILENT_DELAY = 600000; // –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–∏—à–∏–Ω—ã
        const SMOKE_SHOW_TIME = 1100; // —Å–∫–æ–ª—å–∫–æ –¥–µ—Ä–∂–∏—Ç—Å—è –¥—ã–º
        const TEXT_APPEAR_DELAY = 900; // —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç
        const TEXT_SHOW_TIME = 5000; // —Å–∫–æ–ª—å–∫–æ –¥–µ—Ä–∂–∏—Ç—Å—è —Ç–µ–∫—Å—Ç

        /* ===== –≠–õ–ï–ú–ï–ù–¢–´ ===== */

        const smokeGif = document.getElementById("smokeGif");
        const textPng = document.getElementById("textPng");

        /* ===== –¢–ê–ô–ú–ï–†–´ ===== */

        let silentTimer = null;
        let smokeHideTimer = null;
        let textShowTimer = null;
        let textHideTimer = null;

        /* ===== HELPERS ===== */

        function restartGif(img) {
          const src = img.src;
          img.src = "";
          img.src = src;
        }

        function fadeIn(el) {
          el.classList.remove("fade-out");
          el.classList.add("fade-in");
        }

        function fadeOut(el) {
          el.classList.remove("fade-in");
          el.classList.add("fade-out");
        }

        function clearAllTimers() {
          clearTimeout(silentTimer);
          clearTimeout(smokeHideTimer);
          clearTimeout(textShowTimer);
          clearTimeout(textHideTimer);
        }

        function hideAll() {
          fadeOut(smokeGif);
          fadeOut(textPng);
        }

        /* ===== –û–°–ù–û–í–ù–û–ô –≠–§–§–ï–ö–¢ ===== */

        function playSilentEffect() {
          hideAll();

          // üî• —Å—Ç–∞—Ä—Ç –¥—ã–º–∞
          restartGif(smokeGif);
          fadeIn(smokeGif);

          // ‚è± —Å–∫—Ä—ã–≤–∞–µ–º –¥—ã–º —Å—Ç—Ä–æ–≥–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
          smokeHideTimer = setTimeout(() => {
            fadeOut(smokeGif);
          }, SMOKE_SHOW_TIME);

          // üìù –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
          textShowTimer = setTimeout(() => {
            fadeIn(textPng);
          }, TEXT_APPEAR_DELAY);

          // ‚è± —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
          textHideTimer = setTimeout(() => {
            fadeOut(textPng);
            startSilentTimer(); // üîÅ —Å–Ω–æ–≤–∞ –∂–¥—ë–º —Ç–∏—à–∏–Ω—É
          }, TEXT_APPEAR_DELAY + TEXT_SHOW_TIME);
        }

        function startSilentTimer() {
          clearTimeout(silentTimer);
          silentTimer = setTimeout(playSilentEffect, SILENT_DELAY);
        }

        /* ===== –°–ë–†–û–° –ü–û –ê–ö–¢–ò–í–ù–û–°–¢–ò ===== */

        function onUserMessage() {
          clearAllTimers();
          hideAll();
          startSilentTimer();
        }

        /* ===== MINICHAT ===== */

        const ws = new WebSocket("ws://localhost:4848/Chat");

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.Type !== "Message" || !data.Data) return;

            const user = (
              data.Data.Meta?.Login ||
              data.Data.UserName ||
              "guest"
            ).toLowerCase();

            if (user === BOT_NAME) return;

            onUserMessage();
          } catch (e) {
            console.error("WS error:", e);
          }
        };

        /* ===== START ===== */

        startSilentTimer();
      });
    </script>
  </body>
</html>
